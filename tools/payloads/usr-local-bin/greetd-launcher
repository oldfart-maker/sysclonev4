#!/bin/sh
set -eu

CMD="/usr/local/bin/start-sway"

# Minimal, safe defaults for Wayland
[ -n "${XDG_SESSION_TYPE:-}" ] || export XDG_SESSION_TYPE=wayland
[ -n "${XDG_CURRENT_DESKTOP:-}" ] || export XDG_CURRENT_DESKTOP=sway

if command -v tuigreet >/dev/null 2>&1; then
  HELP="$(tuigreet --help 2>&1 || true)"
  FLAGS=""

  has() { printf '%s\n' "$HELP" | grep -q -- "$1"; }

  # add flags only if this tuigreet supports them
  has '--time'            && FLAGS="$FLAGS --time"
  has '--remember-user'   && FLAGS="$FLAGS --remember-user"
  # older releases used --remember instead of --remember-user
  ! has '--remember-user' && has '--remember' && FLAGS="$FLAGS --remember"
  has '--user-menu'       && FLAGS="$FLAGS --user-menu"
  has '--asterisks'       && FLAGS="$FLAGS --asterisks"

  exec tuigreet $FLAGS --cmd "$CMD"
elif command -v agreety >/dev/null 2>&1; then
  exec agreety --cmd "$CMD"
else
  echo "No greeter found (tuigreet/agreety). Falling back to TTY login." >&2
  exec /bin/login -p
fi
