#!/bin/sh
log=/tmp/greetd-greeter.err
exec >>"$log" 2>&1
echo "=== launcher start $(date) uid=$(id -u) gid=$(id -g) ==="
set -ux
CMD="/usr/local/bin/start-sway"
[ -n "${XDG_SESSION_TYPE:-}" ]    || export XDG_SESSION_TYPE=wayland
[ -n "${XDG_CURRENT_DESKTOP:-}" ] || export XDG_CURRENT_DESKTOP=sway
have() { command -v "$1" >/dev/null 2>&1; }
if have tuigreet; then
  HELP="$(tuigreet --help 2>&1 || true)"; FLAGS=""
  printf '%s' "$HELP" | grep -q -- '--time'      && FLAGS="$FLAGS --time"
  printf '%s' "$HELP" | grep -q -- '--user-menu' && FLAGS="$FLAGS --user-menu"
  echo "[launcher] exec: tuigreet $FLAGS --cmd $CMD"
  exec tuigreet $FLAGS --cmd "$CMD"
elif have agreety; then
  echo "[launcher] exec: agreety --cmd $CMD"
  exec agreety --cmd "$CMD"
else
  echo "[launcher] no greeter found; exec /bin/login -p"
  exec /bin/login -p
fi
