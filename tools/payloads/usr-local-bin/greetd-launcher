#!/bin/sh
set -eu

CMD="/usr/local/bin/start-sway"

# Minimal environment so sway/Wayland donâ€™t choke
[ -n "${XDG_SESSION_TYPE:-}" ] || export XDG_SESSION_TYPE=wayland
[ -n "${XDG_CURRENT_DESKTOP:-}" ] || export XDG_CURRENT_DESKTOP=sway

# Log somewhere greeter can write
LOG="/tmp/greetd-greeter.err"
exec 2>>"$LOG"

if command -v tuigreet >/dev/null 2>&1; then
  HELP="$(tuigreet --help 2>&1 || true)"
  FLAGS=""
  has() { printf '%s\n' "$HELP" | grep -q -- "$1"; }
  has '--time'            && FLAGS="$FLAGS --time"
  has '--remember-user'   && FLAGS="$FLAGS --remember-user"
  ! has '--remember-user' && has '--remember' && FLAGS="$FLAGS --remember"
  has '--user-menu'       && FLAGS="$FLAGS --user-menu"
  has '--asterisks'       && FLAGS="$FLAGS --asterisks"
  exec tuigreet $FLAGS --cmd "$CMD"
elif command -v agreety >/dev/null 2>&1; then
  exec agreety --cmd "$CMD"
else
  exec /bin/login -p
fi
