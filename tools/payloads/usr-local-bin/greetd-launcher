#!/bin/sh
set -eu
CMD="/usr/local/bin/start-sway"

[ -n "${XDG_SESSION_TYPE:-}" ] || export XDG_SESSION_TYPE=wayland
[ -n "${XDG_CURRENT_DESKTOP:-}" ] || export XDG_CURRENT_DESKTOP=sway

LOG="/tmp/greetd-greeter.err"
touch "$LOG" 2>/dev/null || LOG="/dev/null"

if command -v tuigreet >/dev/null 2>&1; then
  HELP="$(tuigreet --help 2>&1 || true)"
  has() { printf '%s\n' "$HELP" | grep -q -- "$1"; }
  FLAGS=""
  has '--time'          && FLAGS="$FLAGS --time"
  if has '--remember-user'; then
    FLAGS="$FLAGS --remember-user"
  elif has '--remember'; then
    FLAGS="$FLAGS --remember"
  fi
  has '--user-menu'     && FLAGS="$FLAGS --user-menu"
  has '--asterisks'     && FLAGS="$FLAGS --asterisks"
  exec tuigreet $FLAGS --cmd "$CMD" 2>>"$LOG"
elif command -v agreety >/dev/null 2>&1; then
  exec agreety --cmd "$CMD" 2>>"$LOG"
else
  echo "No greeter found (tuigreet/agreety). Falling back to login." >&2
  exec /bin/login -p 2>>"$LOG"
fi
